/*
  JACK's DICTION.CPP
*/

#include <stdio.h>
#include <string.h>
#include <conio.h>
#include "common.h"
#include "graph.h"
#include "menu.h"
#include "himem.h"
#include "autohan.h"

#define N_DICBUFF 30

void far Diction(void);
void far RegisterDic(signed char far *n_default);
signed int far RegisterWord(signed char far *n_word, signed char far *n_wordhelp);
signed long far SearchWord(signed char far *n_word);
void far ReadWord(signed char far *n_word, signed char far *n_wordhelp);

void far ReadWord(signed char far *n_word, signed char far *n_wordhelp)
{
 FILE *fp;
 signed char n_data;
 signed char far *n_buff;
 signed char far *n_buff2;
 signed char n_flag=N_False;
           if((fp=fopen(MakePath("diction\\jack.dbs"), "rb"))==NULL)return;
           n_buff=new(signed char far [N_DICBUFF+1]);
           n_buff2=new(signed char far [41]);
           do{
              if(fread(&n_data, sizeof(n_data), 1, fp)==0){n_data=(-1);break;}
              if(fread(n_buff, (size_t)n_data, 1, fp) ==0){n_data=(-1);break;}
              if(fread(&n_data, sizeof(n_data), 1, fp)==0){n_data=(-1);break;}
              if(fread(n_buff2, (size_t)n_data, 1, fp) ==0){n_data=(-1);break;}
              if(strcmp(n_buff, n_word)==0)
              {
               n_flag=N_True;
               strcpy(n_wordhelp, n_buff2);
               break;
              }
              if(kbhit())
              {
               if(getch()==0x1b)
               {
                n_flag=N_Error;
                n_data=(-1);
                break;
               }
               while(kbhit())getch();
              }
             }while(n_data);
           delete(n_buff);
           delete(n_buff2);
           if(n_flag==N_False)strcpy(n_wordhelp, "\x10 단어가 등록되어있지 않습니다.");
           else if(n_flag==N_Error)strcpy(n_wordhelp, "\x10 단어검색을 취소하셨습니다.");
           fclose(fp);
           *(n_wordhelp+38)=0;
           *(n_wordhelp+39)=0;
           return;
}

void far Diction(void)
{
 signed int n_key;
 unsigned int n_screenhandle=himemAlloc((unsigned int)((ComputeWindow(100, 200, 539, 282)>>10)+30L));
 signed char far *n_word=new(signed char far [N_DICBUFF]);
 signed char far *n_wordhelp=new(signed char far [41]);
           Help("찾고자 하는 단어를 입력하세요.");
           s_MD.IsWin=N_True;
           MC(N_False);
           Window(100, 200, 539, 282, "만능사전", LIGHTGRAY, &s_wd, n_screenhandle);
           Puts(111, 231, "찾을단어:", WHITE, N_Default);
           Puts(110, 230, "찾을단어:", DARKGRAY, N_Default);
           Puts(111, 261, "단어해설:", WHITE, N_Default);
           Puts(110, 260, "단어해설:", DARKGRAY, N_Default);
           MC(N_True);
           *(n_word)=0;
           s_nowgetmode=N_ENGLISH;
           while(N_True)
           {
            s_autogets=N_AUTOINIT|N_AUTOMOUSE;
            s_ptr=strlen(n_word);
            n_key=Gets(s_wd.x1+90, s_wd.y1+30, n_word, n_word, 30, BLACK, LIGHTGRAY);
            if(n_key==0x1b)break;
            WindowProcess(&s_wd);
            if(s_wd.command==WIN_CLOSE||s_mb==N_RIGHTBUTTON)break;
            if(s_mb==N_RIGHTBUTTON)break;
            if(s_wd.command==WIN_MOVE||*(n_word)==0||*(n_word)==0x20)continue;
            if(MouseCheck(s_wd.x1+90, s_wd.y1+30, s_wd.x1+330, s_wd.y1+45, N_LEFTBUTTON)==N_False&&s_mb==N_LEFTBUTTON)continue;
            Help("단어를 검색중입니다. 잠시 기다려 주십시요.");
            drwfillbox(SET, LIGHTGRAY, s_wd.x1+90, s_wd.y1+60, s_wd.x1+410, s_wd.y1+75);
            Puts(s_wd.x1+90, s_wd.y1+60, "& 검색중 &", BLACK, LIGHTGRAY);
            ReadWord(n_word, n_wordhelp);
            MC(N_False);
            drwfillbox(SET, LIGHTGRAY, s_wd.x1+90+(strlen(n_wordhelp)<<3), s_wd.y1+60, s_wd.x1+410, s_wd.y1+75);
            Puts(s_wd.x1+90, s_wd.y1+60, n_wordhelp, BLACK, LIGHTGRAY);
            MC(N_True);
            Help(n_wordhelp);
           }
           MC(N_False);
           PutImageXMS(s_wd.x1, s_wd.y1, s_wd.x2, s_wd.y2, n_screenhandle);
           MC(N_True);
           himemFree(n_screenhandle);
           delete(n_word);
           delete(n_wordhelp);
           s_MD.IsWin=N_False;
}

void far RegisterDic(signed char far *n_default)
{
 signed int n_key;
 unsigned int n_screenhandle=himemAlloc((unsigned int)((ComputeWindow(100, 150, 539, 330)>>10)+30L));
 signed char far *n_word=new(signed char far [N_DICBUFF+1]);
 signed char far *n_wordhelp=new(signed char far [41]);
           Re_Register:;
           Help("단어를 등록해주세요. \(취소:ESC\)");
           MC(N_False);
           Window(100, 150, 539, 330, "신규단어 등록", LIGHTGRAY, &s_wd, n_screenhandle);
           Puts(111, 181, "등록단어:", WHITE, N_Default);
           Puts(110, 180, "등록단어:", DARKGRAY, N_Default);
           Puts(111, 211, "단어해설:", WHITE, N_Default);
           Puts(110, 210, "단어해설:", DARKGRAY, N_Default);
           PushRec(110, 245, 529, 246);
           Puts(110, 260, "1. 단어는 최고 30 byte까지 기록가능합니다.", BLACK, N_Default);
           Puts(110, 276, "2. 단어해설은 최고 40 byte까지 기록가능합니다.", BLACK, N_Default);
           Puts(110, 292, "3. 등록단어의 제한갯수는 무제한입니다.", BLACK, N_Default);
           Puts(110, 308, "4. 영어단어 및 다른 단어도 등록이 가능합니다.", BLACK, N_Default);
           MC(N_True);
           strcpy(n_word, n_default);
           strcpy(n_wordhelp, "");
           s_autogets=N_AUTOMOUSE|N_AUTOINIT|N_AUTOARROW|N_AUTOTAB;
           while(N_True)
           {
            s_ptr=strlen(n_word);
            s_nowgetmode=N_ENGLISH;
            MC(N_False); NowGetMode(); MC(N_True);
            again_loop1:;
            n_key=Gets(s_wd.x1+90, s_wd.y1+30, n_word, n_word, N_DICBUFF, BLACK, LIGHTGRAY);
            if(n_key==0x1b)break;
            WindowProcess(&s_wd);
            if(s_wd.command==WIN_CLOSE||s_mb==N_RIGHTBUTTON)break;
            if(s_wd.command==WIN_MOVE)
            {
             s_wd.command=WIN_NONE;
             goto again_loop1;
            }
            if(MouseCheck(s_wd.x1+90, s_wd.y1+60, s_wd.x1+410, s_wd.y1+75, N_LEFTBUTTON)==N_False&&s_mb==N_LEFTBUTTON)goto again_loop1;
            s_ptr=strlen(n_wordhelp);
            s_nowgetmode=N_HANGUL;
            MC(N_False); NowGetMode(); MC(N_True);
            again_loop2:;
            n_key=Gets(s_wd.x1+90, s_wd.y1+60, n_wordhelp, n_wordhelp, 40, BLACK, LIGHTGRAY);
            if(n_key==0x1b)break;
            if(n_key==0x0d)break;
            WindowProcess(&s_wd);
            if(s_wd.command==WIN_CLOSE||s_mb==N_RIGHTBUTTON)break;
            if(s_wd.command==WIN_MOVE)
            {
             s_wd.command=WIN_NONE;
             goto again_loop2;
            }
            if(MouseCheck(s_wd.x1+90, s_wd.y1+30, s_wd.x1+330, s_wd.y1+45, N_LEFTBUTTON)==N_False&&s_mb==N_LEFTBUTTON)goto again_loop2;
           }
           MC(N_False);
           PutImageXMS(s_wd.x1, s_wd.y1, s_wd.x2, s_wd.y2, n_screenhandle);
           MC(N_True);
           if(n_key==0x0d)
           {
            if(*(n_word)==0)
            {
             Check("단어가 입력되지 않았습니다.");
            }
            else if(YesNo("단어를 등록하시겠습니까?", N_Yes)==N_Yes)RegisterWord(n_word, n_wordhelp);
            if(YesNo("계속해서 단어를 등록하시겠습니까?", N_Yes)==N_Yes)
            {
             strcpy(n_default, "");
             goto Re_Register;
            }
           }
           himemFree(n_screenhandle);
           delete(n_word);
           delete(n_wordhelp);
}

signed int far RegisterWord(signed char far *n_word, signed char far *n_wordhelp)
{
 FILE *fp;
 signed char n_data;
           if(SearchWord(n_word)!=(-1L))
           {
            if(YesNo("이미 등록되어있습니다. 재등록할까요?", N_No)==N_No)return(N_False);
           }
           if((fp=fopen(MakePath("diction\\jack.dbs"), "ab"))==NULL)return(N_False);
           n_data=strlen(n_word)+1;
           fwrite(&n_data, sizeof(n_data), 1, fp);
           fwrite(n_word, n_data, 1, fp);
           n_data=strlen(n_wordhelp)+1;
           fwrite(&n_data, sizeof(n_data), 1, fp);
           fwrite(n_wordhelp, n_data, 1, fp);
           fclose(fp);
           return(N_True);
}

signed long far SearchWord(signed char far *n_word)
{
 FILE *fp;
 signed char n_data;
 signed long n_return=0L;
 signed char far *n_buff;
           Help("단어가 이미 존재하는지 검색중입니다.");
           if((fp=fopen(MakePath("diction\\jack.dbs"), "rb"))==NULL)return((-1L));
           n_buff=new(signed char far [N_DICBUFF+1]);
           do{
              if(fread(&n_data, sizeof(n_data), 1, fp)==0){n_data=(-1);break;}
              if(fread(n_buff, (size_t)n_data, 1, fp) ==0){n_data=(-1);break;}
              if(strcmp(n_buff, n_word)==0)break;
              if(fread(&n_data, sizeof(n_data), 1, fp)==0){n_data=(-1);break;}
              if(fseek(fp, n_data, SEEK_CUR)!=0){n_data=(-1);break;}
              n_return++;
             }while(n_data);
           delete(n_buff);
           fclose(fp);
           if(n_data==(-1))return((-1L));
           return(n_return);
}

/* End of source */